<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cloud-less Python IDE</title>
    
    <style id="pyscript-styles">
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; margin: 0; background: #1e1e1e; color: white; overflow: hidden; }
        
        #sidebar { width: 260px; background: #252526; padding: 15px; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #file-list { flex-grow: 1; overflow-y: auto; margin-top: 10px; }
        .file-item { cursor: pointer; padding: 8px 12px; margin: 2px 0; border-radius: 4px; font-size: 14px; transition: background 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .file-item:hover { background: #37373d; }
        .file-item.active { background: #094771; color: white; }
        .delete-btn { color: #ff5f56; font-weight: bold; padding: 0 5px; opacity: 0.5; }
        .delete-btn:hover { opacity: 1; }

        #editor-area { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        #controls { padding: 10px 20px; background: #333; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #444; }
        #current-file-label { font-weight: bold; color: #61dafb; min-width: 100px; }
        
        textarea { flex-grow: 1; background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; padding: 20px; border: none; outline: none; font-size: 16px; resize: none; line-height: 1.5; }
        
        #output-container { height: 250px; display: flex; border-top: 2px solid #555; }
        #output { flex: 1; background: #000; color: #00ff00; padding: 15px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 14px; white-space: pre-wrap; }
        #debug-log { width: 300px; background: #111; color: #aaa; padding: 10px; font-size: 11px; font-family: monospace; overflow-y: auto; border-left: 1px solid #333; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-error { color: #ff5f56; }
        .log-success { color: #28a745; }
        .log-warn { color: #ffcc00; }

        button { cursor: pointer; background: #007acc; color: white; border: none; padding: 6px 16px; border-radius: 4px; font-size: 14px; transition: background 0.2s; }
        button:hover { background: #0062a3; }
        button.run { background: #28a745; font-weight: bold; }
        button.run:hover { background: #218838; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        .new-file-input-group { display: flex; gap: 5px; margin-top: 10px; }
        input[type="text"] { background: #3c3c3c; border: 1px solid #555; color: white; padding: 5px; border-radius: 3px; flex-grow: 1; outline: none; }
    </style>

    <script>
        function logDebug(msg, type = 'info') {
            const log = document.getElementById('debug-log');
            if (!log) return;
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (type !== 'info' ? ' log-' + type : '');
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(`[DEBUG] ${msg}`);
        }

        const PYSCRIPT_VERSION = "2024.1.1";
        const cssUrl = `https://pyscript.net/releases/${PYSCRIPT_VERSION}/core.css`;
        const jsUrl = `https://pyscript.net/releases/${PYSCRIPT_VERSION}/core.js`;
        const proxyPrefix = "https://api.codetabs.com/v1/proxy?quest=";

        function loadAssets() {
            window.addEventListener('DOMContentLoaded', () => logDebug("DOM Loaded, starting asset load..."));
            
            // Load CSS
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = cssUrl;
            link.onload = () => logDebug("PyScript CSS loaded successfully", "success");
            link.onerror = () => {
                logDebug("Failed to load PyScript CSS, trying proxy...", "warn");
                link.href = proxyPrefix + encodeURIComponent(cssUrl);
            };
            document.head.appendChild(link);

            // Load JS
            const script = document.createElement('script');
            script.type = 'module';
            script.src = jsUrl;
            script.onload = () => logDebug("PyScript JS core loaded successfully", "success");
            script.onerror = () => {
                logDebug("Failed to load PyScript JS, trying proxy...", "warn");
                const proxyScript = document.createElement('script');
                proxyScript.type = 'module';
                proxyScript.src = proxyPrefix + encodeURIComponent(jsUrl);
                proxyScript.onload = () => logDebug("PyScript JS loaded via proxy", "success");
                proxyScript.onerror = () => logDebug("FATAL: Proxy asset load failed", "error");
                document.head.appendChild(proxyScript);
            };
            document.head.appendChild(script);
        }
        loadAssets();
    </script>
</head>
<body>

<div id="sidebar">
    <h3 style="margin-top:0">üìÅ Workspace</h3>
    <div class="new-file-input-group">
        <input type="text" id="new-filename" placeholder="name.py">
        <button onclick="createNewFile()">+</button>
    </div>
    <div id="file-list"></div>
    <div style="font-size: 10px; color: #888; margin-top: 10px;">* Files are saved to browser local storage.</div>
</div>

<div id="editor-area">
    <div id="controls">
        <span id="current-file-label">main.py</span>
        <button onclick="saveCurrentFile()">üíæ Save</button>
        <button class="run" id="run-btn" onclick="runPythonCode()">‚ñ∂ Run Code</button>
        <button onclick="clearOutput()" style="background: #444; margin-left: auto;">Clear</button>
    </div>
    <textarea id="code-input" spellcheck="false" placeholder="# Write your Python code here..."></textarea>
    
    <div id="output-container">
        <div id="output">System: Initializing PyScript...</div>
        <div id="debug-log">
            <div class="log-entry">--- Debug Log Start ---</div>
        </div>
    </div>
</div>

<py-config>
    packages = ["numpy"]
</py-config>

<script type="py" id="main-worker" worker>
    import js
    from pyscript import sync
    import sys

    class WebOutput:
        def write(self, text):
            js.appendTerminal(text)
        def flush(self):
            pass

    sys.stdout = WebOutput()
    sys.stderr = WebOutput()

    def run_user_code(code, files_data):
        for filename, content in files_data.items():
            with open(filename, "w") as f:
                f.write(content)
        try:
            exec(code, globals())
        except Exception as e:
            print(f"\n‚ùå Error: {e}")

    sync.run_user_code = run_user_code
    js.logDebug("Python Worker: Ready & Sync Exported", "success")
</script>

<script>
    let currentFile = "main.py";

    if (!localStorage.getItem("main.py")) {
        localStorage.setItem("main.py", "import numpy as np\n\na = input('Number 1: ')\nb = input('Number 2: ')\n\n# Note: input() returns strings!\nresult = float(a) + float(b)\n\nprint(f'Sum using numpy: {result}')");
    }

    function updateFileList() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.endsWith('.py')) {
                const div = document.createElement('div');
                div.className = `file-item ${key === currentFile ? 'active' : ''}`;
                const nameSpan = document.createElement('span');
                nameSpan.innerText = key;
                nameSpan.onclick = () => switchFile(key);
                div.appendChild(nameSpan);
                list.appendChild(div);
            }
        }
    }

    function switchFile(filename) {
        saveCurrentFile(); 
        currentFile = filename;
        document.getElementById('current-file-label').innerText = filename;
        document.getElementById('code-input').value = localStorage.getItem(filename) || "";
        updateFileList();
    }

    function saveCurrentFile() {
        const content = document.getElementById('code-input').value;
        localStorage.setItem(currentFile, content);
    }

    function createNewFile() {
        const input = document.getElementById('new-filename');
        let name = input.value.trim();
        if (!name) return;
        if (!name.endsWith('.py')) name += '.py';
        if (!localStorage.getItem(name)) {
            localStorage.setItem(name, `# File: ${name}\n`);
            input.value = '';
            updateFileList();
            switchFile(name);
        }
    }

    function clearOutput() {
        document.getElementById('output').innerHTML = "";
    }

    window.appendTerminal = function(text) {
        const output = document.getElementById('output');
        const span = document.createElement('span');
        span.textContent = text;
        output.appendChild(span);
        output.scrollTop = output.scrollHeight;
    };

    async function runPythonCode() {
        const runBtn = document.getElementById('run-btn');
        const workerElement = document.getElementById('main-worker');
        
        if (!workerElement || !workerElement.pyWorker) {
            logDebug("Run Attempt: Worker not found", "error");
            appendTerminal("\nSystem Error: PyScript worker is still loading...");
            return;
        }

        const pyWorker = workerElement.pyWorker;
        if (!pyWorker.sync || !pyWorker.sync.run_user_code) {
            logDebug("Run Attempt: Sync function not exported yet", "warn");
            appendTerminal("\nSystem Error: Python environment is not fully ready...");
            return;
        }

        saveCurrentFile();
        const code = document.getElementById('code-input').value;
        runBtn.disabled = true;
        runBtn.innerText = "‚åõ Running...";
        
        const allFiles = {};
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.endsWith('.py')) allFiles[k] = localStorage.getItem(k);
        }

        try {
            await pyWorker.sync.run_user_code(code, allFiles);
        } catch (err) {
            logDebug("Execution Error: " + err.message, "error");
            appendTerminal("\nSystem Error: " + err.message);
        } finally {
            runBtn.disabled = false;
            runBtn.innerText = "‚ñ∂ Run Code";
        }
    }

    window.addEventListener('load', () => {
        document.getElementById('code-input').value = localStorage.getItem(currentFile) || "";
        updateFileList();
        
        const startTime = Date.now();
        const checkReady = setInterval(() => {
            const workerElement = document.getElementById('main-worker');
            const out = document.getElementById('output');
            
            if (workerElement && workerElement.pyWorker && workerElement.pyWorker.sync) {
                logDebug("CheckReady: Environment confirmed fully functional", "success");
                if(out.innerHTML.includes("Initializing")) {
                    out.innerHTML = "--- Terminal Ready ---\n";
                }
                clearInterval(checkReady);
            } else if (Date.now() - startTime > 45000) {
                logDebug("CheckReady: Loading Timeout Reached (45s)", "error");
                if(out.innerHTML.includes("Initializing")) {
                    out.innerHTML = "System Error: PyScript took too long to load. Check the debug log on the right.\n";
                }
                clearInterval(checkReady);
            }
        }, 1000);
    });
</script>

</body>
</html>
